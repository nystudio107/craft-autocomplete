# Autocomplete for Craft CMS 3.x

[![Scrutinizer Code Quality](https://scrutinizer-ci.com/g/nystudio107/craft-autocomplete/badges/quality-score.png?b=develop)](https://scrutinizer-ci.com/g/nystudio107/craft-autocomplete/?branch=develop) [![Code Coverage](https://scrutinizer-ci.com/g/nystudio107/craft-autocomplete/badges/coverage.png?b=develop)](https://scrutinizer-ci.com/g/nystudio107/craft-autocomplete/?branch=develop) [![Build Status](https://scrutinizer-ci.com/g/nystudio107/craft-autocomplete/badges/build.png?b=develop)](https://scrutinizer-ci.com/g/nystudio107/craft-autocomplete/build-status/develop) [![Code Intelligence Status](https://scrutinizer-ci.com/g/nystudio107/craft-autocomplete/badges/code-intelligence.svg?b=develop)](https://scrutinizer-ci.com/code-intelligence)

Provides Twig template IDE autocompletion for Craft CMS and plugin/module variables.

Works with PhpStorm provided the [Symfony Support plugin](https://plugins.jetbrains.com/plugin/7219-symfony-plugin
) is installed. VSCode currently does not support intellisense for Twig extensions.

> Craft 3.7.8 added autocompletion for Craftâ€™s global Twig variables, however, this does not include autocomplete support for plugins and modules.

## Requirements

This plugin requires Craft CMS 3.0.0 or later.

## Usage

1. Install the package using composer.

    ```
    composer require nystudio107/craft-autocomplete
    ```

2. Ensure that the [Symfony Support plugin](https://plugins.jetbrains.com/plugin/7219-symfony-plugin
) for PhpStorm is installed and enabled.  
    
3. Ensure that `devMode` is enabled.

4. Visit the Craft site on which the package is installed to generate the autocomplete classes, or run the following console command.

    ```shell
    php craft autocomplete/generate
    ```

Once your IDE indexes the autocomplete classes, autocompletion for Craft and all plugins and modules will immediately become available in your Twig templates.

![screenshot](https://user-images.githubusercontent.com/57572400/125784167-618830ae-e475-4faf-81d3-194ad7ce3a08.png)

## Regenerating Autocomplete Classes

The autocomplete classes are regenerated every time you install or uninstall a plugin. If you manually add a plugin or module that registers variables on the Craft global variable, you can regenerate the autocomplete classes by running the following console command.

```shell
php craft autocomplete/regenerate
```

## Extending

In addition to the provided autocomplete generator types, you can write your own by implementing the `GeneratorInterface` class or extending the abstract `Generator` class (recommended).

```php
<?php
namespace vendor\package;

use nystudio107\autocomplete\base\Generator;

class MyAutocompleteGenerator extends Generator
{
    // Override base methods
}
```

To register your generator type, listen for the `EVENT_REGISTER_AUTOCOMPLETE_GENERATORS` event and add your class to the `types` property.

```php
use nystudio107\autocomplete\Autocomplete;
use craft\events\RegisterComponentTypesEvent;
use yii\base\Event;

Event::on(Autocomplete::class,
    Autocomplete::EVENT_REGISTER_AUTOCOMPLETE_GENERATORS,
    function(RegisterComponentTypesEvent $event) {
        $event->types[] = MyAutocompleteGenerator::class;
    }
);
```

## How It Works

How works this black magic, you may find yourself asking. Firstly, it is important to understand that the 
[Symfony Support plugin](https://plugins.jetbrains.com/plugin/7219-symfony-plugin
) (written in Java), does not actually evaluate any PHP code. Instead, it parses all Twig extension PHP classes looking for key/value arrays that are returned and makes their values available as global variables for autocompletion. If a plugin or module (or even Craft pre 3.7.8) does not return a key/value array directly then autocompletion simply will not work (Andrew had to discover this by source-diving the Symfony Support plugin). 

Behind the scenes, this package is a Yii extension (and a module) that [bootstraps itself](https://www.yiiframework.com/doc/guide/2.0/en/structure-extensions#bootstrapping-classes) and only ever does anything provided that `devMode` is enabled (so in theory only in development environments). During the bootstrapping process, the package generates two classes, `AutocompleteTwigExtension` and `AutocompleteVariable`, if they do not already exist or if a Craft plugin was just installed or uninstalled. The `AutocompleteTwigExtension` class is generated by evaluating all the Twig globals that have been registered. The `AutocompleteVariable` class is generated by dynamically evaluating the global Craft variable, including any variables that have been registered on it (by plugins and modules).

Once PhpStorm has indexed these two classes, autocompletion for Craft and all plugins and modules immediately becomes available in your Twig templates, just like magic!

---

Brought to you by [nystudio107](https://nystudio107.com) and [PutYourLightsOn](https://putyourlightson.com/).
